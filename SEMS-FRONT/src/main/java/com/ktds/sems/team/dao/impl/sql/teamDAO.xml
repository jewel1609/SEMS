<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="teamDAO">
	
	<insert id="addNewTeamBBS" parameterType="TeamBBSVO">
		INSERT INTO TEAM_BBS (
									   TEAM_BBS_ID, 
									   TEAM_ID,
									   TITLE, 
									   DESCRIPT,
									   MBR_ID, 
									   CREATED_DATE,
									   <if test="isNotice != null">
								 	   IS_NOTICE
									   </if>
									
					   			  ) 
		VALUES 					( 
									   #{teamBBSId},
									   #{teamId},
									 	#{title},
										#{descript},
										#{memberId},
									 	SYSDATE,
									 	<if test="isNotice != null">
									 	#{isNotice}
									 	</if>
								)
	</insert>
	
	<select id="getNextTeamBBSSeq"  resultType = "_int">
		SELECT	TEAM_BBS_SEQ.NEXTVAL
		FROM	DUAL
	</select>
	
	<select id="getSysDate" resultType = "String">
		SELECT	TO_CHAR(SYSDATE , 'YYYYMMHH')
		FROM	DUAL
	</select>
	
	<select id="getTeamBBSList" resultType="TeamBBSVO">
		SELECT	TEAM_BBS.TEAM_BBS_ID teamBBSId,
	    		TEAM_BBS.TEAM_ID teamId, 
	    		TEAM_BBS.TITLE title, 
	    		BBS_HTR.HITS hits,
			    TEAM_BBS.DESCRIPT descript, 
			    TEAM_BBS.LIKE_CNT likeCount,
			    TEAM_BBS.DISLIKE_CNT disLikeCount, 
			    TEAM_BBS.MBR_ID memberId, 
			    TEAM_BBS.CREATED_DATE createdDate, 
		   		TEAM_BBS.MODIFIED_DATE modifiedDate,
		   		TEAM_BBS.IS_NOTICE isNotice
		FROM	(
					SELECT	ROWNUM AS RNUM
							, TEAM_BBS.*
					FROM	(
								SELECT	*
								FROM	TEAM_BBS
								ORDER	BY TEAM_BBS_ID DESC
							) TEAM_BBS
					WHERE	ROWNUM <![CDATA[<=]]> #{endIndex}
				) TEAM_BBS
				,(
					SELECT  BBS_ID, COUNT(*) HITS
					FROM    BBS_HTR
					GROUP   BY BBS_ID
				) BBS_HTR
		WHERE	RNUM >= #{startIndex}
		AND		BBS_HTR.BBS_ID (+)= TEAM_BBS.TEAM_BBS_ID
	</select>
	
	<select  id="getSearchedBBSCount" resultType="_int">
		SELECT	COUNT(*)
		FROM	TEAM_BBS
	</select>	
	
	<select id="getTeamBBS" parameterType="String" resultType="TeamBBSVO">
		SELECT		TEAM_BBS_ID teamBBSId,
		    		TEAM_ID teamId, 
		    		TITLE title, 
					DESCRIPT descript, 
					COUNT_HITS.HITS hits, 
					LIKE_CNT likeCount,
					DISLIKE_CNT disLikeCount, 
					MBR_ID memberId, 
					CREATED_DATE createdDate, 
			   		MODIFIED_DATE modifiedDate,
			   		IS_NOTICE isNotice
		FROM		TEAM_BBS
					,
					(
						SELECT	COUNT(*) HITS
						FROM	BBS_HTR
						WHERE 	BBS_ID = #{teamBBSId}
					) COUNT_HITS
		WHERE		TEAM_BBS_ID = #{teamBBSId}
	</select>
	
	<select id="isAlreadyCheckBBS" parameterType="TeamBBSVO" resultType="_int">
		SELECT	COUNT(*)
		FROM	BBS_HTR
		WHERE	BBS_ID = #{teamBBSId}
		AND		MBR_ID = #{memberId}
	</select>
		
	<insert id="addHitsRecord" parameterType="TeamBBSVO">
		INSERT INTO BBS_HTR (
		  						 BBS_HTR_ID
		  						 , MBR_ID
		  						 , BBS_ID
		  					) 
		VALUES				( 
								 #{bbsHistoryId},	
								 #{memberId},
								 #{teamBBSId}
						    )
	</insert>
	
	<select id="getNextBBSHistorySeq" resultType="_int">
		SELECT	BBS_HTR_ID_SEQ.NEXTVAL
		FROM	DUAL
	</select>
	
	<select id="checkDislikeByTeamBBSVO" parameterType="TeamBBSVO" resultType="_int">
		SELECT	COUNT(*)
		FROM	BBS_HTR
		WHERE	MBR_ID 	= #{memberId}
		AND		BBS_ID	= #{teamBBSId}
		AND		DISLIKE	= 'Y'
	</select>
	
	<update id="addLikeRecord" parameterType="TeamBBSVO">
		UPDATE	BBS_HTR
		SET		LIKE = 'Y'
		WHERE	MBR_ID = #{memberId}
		AND		BBS_ID	= #{teamBBSId}
	</update>
	
	<select id="checkLikeByTeamBBSVO" parameterType="TeamBBSVO" resultType="_int">
		SELECT	COUNT(*)
		FROM	BBS_HTR
		WHERE	MBR_ID  = #{memberId}
		AND		BBS_ID	= #{teamBBSId}
		AND		LIKE	= 'Y'
	</select>
	
	<update id="addDislikeRecord" parameterType="TeamBBSVO">
		UPDATE	BBS_HTR
		SET		DISLIKE = 'Y'
		WHERE	MBR_ID = #{memberId}
		AND		BBS_ID	= #{teamBBSId}
	</update>
</mapper>