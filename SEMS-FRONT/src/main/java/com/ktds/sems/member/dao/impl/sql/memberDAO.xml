<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="MemberDAO">
	<insert id="addNewMember" parameterType="MemberVO">
		INSERT INTO MBR	(
							ID
							, PWD
							, NM
							, EMAIL
							, HIGHEST_EDU_LV
							, UNIV_NM
							, MJR_NM
							, GRDT_TP
							, BRTH_DT
							, PHONE_NMB
							, MBR_TP
							, SALT
							, LATEST_LGI_DT
						)
		VALUES 			( 
							#{id}
							, #{password}
							, #{name}
							, #{email}
							, #{highestEducationLevel}
							, #{universityName}
							, #{majorName}
							, #{graduationType}
							, #{birthDate}
							, #{phoneNumber}
							, #{memberType}
							, #{salt}
							, SYSDATE
						)
	</insert>
	<select id="getSaltById" parameterType="string" resultType="string">
		SELECT	SALT salt
		FROM	MBR
		WHERE	ID = #{ id }
	</select>
	<select id="login" parameterType="MemberVO" resultType="MemberVO">
		SELECT	ID id
				, PWD password
				, NM name
				, EMAIL email
				, HIGEST_EDU_LV highestEducationLevel
				, UNIV_NM universityName
				, MJR_NM majorName
				, GRDT_TP graduationType
				, BRTH_DT birthDate
				, PHONE_NMB phoneNumber
				, MBR_TP memberType
				, SALT salt
				, LGI_F_CT loginFailCount
				, IS_ACC_LCK isAccountLock
				, LATEST_LGI_DT latestLoginDate
				, RSN_DT resignDate
				, RSN isResign
				, MDF_F_CT modifyFailCount
				, IS_MDF_LCK isModifyLock
		FROM	MBR
		WHERE	ID = #{id}
		AND		PWD = #{password}
	</select>
	<select id="isAccountLock" parameterType="string" resultType="string">
		SELECT	IS_ACC_LCK
		FROM	MBR
		WHERE	ID = #{id}
	</select>
	<insert id="loginHistory" parameterType="loginHistoryVO">
		INSERT INTO LGI_HTR	(
								LGI_HTR_ID
								, MBR_ID
								, LGI_IP
								, LGI_DT
								, LGO_DT
							) 
		VALUES				(
								LGI_HTR_ID_SEQ.NEXTVAL
								, #{ mbrId }
								, #{ lgiIp }
								, SYSDATE
								, SYSDATE 
		 					)
	</insert>
	<update id="logoutHistory" parameterType="loginHistoryVO">
		UPDATE	LGI_HTR
		SET		LGO_DT = SYSDATE
		WHERE	LGI_HTR_ID = #{ lgiHtrId }
	</update>
	<update id="loginSuccess" parameterType="string">
		UPDATE	MBR
		SET		LGI_F_CT = 0
				, IS_ACC_LCK = 'N'
				, LATEST_LGI_DT = SYSDATE
		WHERE	ID = #{id}
	</update>
	<update id="plusLoginFailCount" parameterType="string">
		UPDATE	MBR
		SET		LGI_F_CT = LGI_F_CT + 1
				, LATEST_LGI_DT = SYSDATE
		WHERE	ID = #{id}
	</update>
	<update id="updateAccountLock" parameterType="string">
		UPDATE	MBR
		SET		IS_ACC_LCK = 'Y'
		WHERE	ID = #{id}
		AND		LGI_F_CT >= 5
	</update>
	<select id="getOneMember" parameterType="string" resultType="MemberVO">
		SELECT	ID id
				, PWD password 
				, NM name
				, EMAIL email
				, HIGHEST_EDU_LV highestEducationLevel
				, UNIV_NM universityName
				, MJR_NM majorName
				, GRDT_TP graduationType
				, BRTH_DT birthDate
				, PHONE_NMB phoneNumber
				, MBR_TP memberType
		FROM	MBR
		WHERE	ID = #{id}
	</select>
	
	<update id="resetModifyLockAndcount" parameterType="string">
		UPDATE	MBR
		SET		MDF_F_CT = 0
				, IS_MDF_LCK = 'N'
		WHERE  ID  = #{id}
	</update>
	
	<update id="plusModifyFailCount" parameterType="string">
		UPDATE	MBR
		SET		MDF_F_CT = MDF_F_CT + 1
		WHERE	ID = #{id}
	</update>
	
	<update id="updateModifyAccountLock" parameterType="string">
		UPDATE	MBR
		SET		IS_MDF_LCK = 'Y'
		WHERE	ID = #{id}
		AND		MDF_F_CT <![CDATA[>=]]> 3
	</update>
	
	<select id="isModifyAccountLock" parameterType="string" resultType="_int">
		SELECT	COUNT(IS_MDF_LCK)
		FROM	MBR
		WHERE	ID = #{id}
		AND		IS_MDF_LCK = 'Y'
	</select>
</mapper>