<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="EducationDAO" >
	<select id="getNextReplySeq" resultType="_int">
		SELECT 	REPLY_ID_SEQ.NEXTVAL
		FROM	DUAL
	</select>
	
	<select id="getNowDate" resultType="string">
		SELECT	TO_CHAR(SYSDATE, 'YYYYMMDD')
		FROM	DUAL
	</select>

	<select id="getTotalEducationCount" resultType="_int">
		SELECT	COUNT(EDU_ID)
		FROM	EDU_INFO
	</select>

	<select id="getSearchedEducationCount" parameterType="EducationVO" resultType="_int" >
			SELECT	COUNT(*)
			FROM	EDU_INFO
			WHERE	1 = 1
			<if test="startDate != null">
	           AND SUBSTR(SRT_DATE, 1, 7) <![CDATA[ >= ]]> #{startDate} 
	           AND SUBSTR(SRT_DATE, 1, 7) <![CDATA[ <= ]]> #{endDate}
	        </if>
	       <if test="cost != null">
	           AND COST = (
	           					SELECT	CD_ID
	           					FROM	EDU_CST
	           					WHERE	CD_NM =  #{cost} 
	           				)
	        </if>
            <if test="educationType != null">
	           AND EDU_TP = (
		           				SELECT	CD_ID
		           				FROM	EDU_TIME
		           				WHERE	CD_NM = #{educationType} 
		           			)
	        </if>   
 		   <if test="educationTitle != null">
	           AND LOWER(EDU_TTL) LIKE '%'||#{educationTitle}||'%'
           </if>
	</select> 
	
	<select id="getOneEducationDetail" parameterType="map" resultType="EducationVO">
		SELECT	EDU.EDU_ID educationId
				, EDU.EDU_CTGR educationCategory
				, EDU.EDU_TTL educationTitle
				, EDU.MBR_ID memberId
				, EDU.MAX_MBR maxMember
				, EDU.EDU_LOC educationLocation
				, EDU.EDU_CLCM educationCurriculum
				, EDU.EDU_INTR educationIntroduce
				, EDU.SRT_DATE startDate
				, EDU.END_DATE endDate
				, EDU.START_TM startTime
				, EDU.END_TM endTime
				, EDU.EDU_TP educationType
		 		, EDU_TIME.CD_NM typeName
				, EDU_CST.CD_NM costName 
		FROM	EDU_INFO EDU
				, EDU_CST
				, EDU_TIME
		WHERE	EDU_ID LIKE #{educationId}
		AND		EDU.COST = EDU_CST.CD_ID
		AND		EDU.EDU_TP = EDU_TIME.CD_ID
	</select>

	<select id="getAllCommentByEducationId" parameterType="map" resultType="QNAVO">
 	SELECT	REPLY_ID replyId
				, EDU_ID eduId
				, PARENT_REPLY_ID parentReplyId
				, ORDER_NO orderNo
				, DESCRIPTION description
				, MBR_ID mbrId
				, LIKE_CNT likeCnt
				, DISLIKE_CNT dislikeCnt
				, TO_CHAR(CREATED_DATE, 'YYYY-MM-DD HH24:MI') createdDate
				, DEP depth
		FROM	(
					SELECT	ROWNUM AS RNUM
							, QNA.*
					FROM	(
								SELECT	QNA.*,
										LEVEL DEP
								FROM	QNA
								WHERE	EDU_ID = #{educationId}
							 	START   WITH PARENT_REPLY_ID = '0'
           						CONNECT BY PRIOR REPLY_ID = PARENT_REPLY_ID 
							) QNA
					WHERE	ROWNUM <![CDATA[<=]]> #{endIndex}
				) QNA
		WHERE	RNUM >= #{startIndex}		
	</select>
<!-- 	<select id="getAllCommentByEducationId" parameterType="string" resultType="QNAVO">
		SELECT	REPLY_ID replyId
				, EDU_ID eduId
				, PARENT_REPLY_ID parentReplyId
				, ORDER_NO orderNo
				, DESCRIPTION description
				, MBR_ID mbrId
				, LIKE_CNT likeCnt
				, DISLIKE_CNT dislikeCnt
				, CREATED_DATE createdDate
		FROM 	QNA
		WHERE	EDU_ID = #{educationId}
	</select> -->
	
	<select id="getAllEducationList" parameterType="EducationSearchVO" resultType="EducationVO">
		SELECT	EDU.EDU_ID educationId
				, EDU.EDU_CTGR educationCategory
				, EDU.EDU_TTL educationTitle
				, EDU.MBR_ID memberId
				, EDU.MAX_MBR maxMember
				, EDU.EDU_LOC educationLocation
				, EDU.EDU_CLCM educationCurriculum
				, EDU.EDU_INTR educationIntroduce
				, EDU.SRT_DATE startDate
				, EDU.END_DATE endDate
				, EDU.START_TM startTime
				, EDU.END_TM endTime
				, EDU_TIME.CD_NM typeName
				, EDU_CST.CD_NM costName
		FROM	(
					SELECT	ROWNUM AS RNUM
							, EDU_INFO.*
					FROM	(
								SELECT	*
								FROM	EDU_INFO
								ORDER	BY EDU_ID DESC
							) EDU_INFO
					WHERE	ROWNUM <![CDATA[<=]]> #{endIndex}
				) EDU
				, EDU_CST
				, EDU_TIME
		WHERE	EDU.COST = EDU_CST.CD_ID
		AND		EDU.EDU_TP = EDU_TIME.CD_ID
		AND		RNUM >= #{startIndex}		
	</select>


	<select id="doSearchList" parameterType="map" resultType="EducationVO">
		SELECT	EDU.EDU_ID educationId
				, EDU.EDU_CTGR educationCategory
				, EDU.EDU_TTL educationTitle
				, EDU.MBR_ID memberId
				, EDU.MAX_MBR maxMember
				, EDU.EDU_LOC educationLocation
				, EDU.EDU_CLCM educationCurriculum
				, EDU.EDU_INTR educationIntroduce
				, EDU.SRT_DATE startDate
				, EDU.END_DATE endDate
				, EDU.START_TM startTime
				, EDU.END_TM endTime
				, EDU_TIME.CD_NM typeName
				, EDU_CST.CD_NM costName
         FROM   (
               SELECT   ROWNUM   AS RNUM
                     , EDU_INFO.*
               FROM   (
                        SELECT   *
                        FROM   EDU_INFO
                        WHERE  1=1	 
			          	<if test="educationVO.startDate != null">
				           AND SUBSTR(SRT_DATE, 1, 7) <![CDATA[ >= ]]> #{educationVO.startDate} 
				           AND SUBSTR(SRT_DATE, 1, 7) <![CDATA[ <= ]]> #{educationVO.endDate}
				        </if>
				        <if test="educationVO.cost != null">
				           AND COST = (
				           					SELECT	CD_ID
				           					FROM	EDU_CST
				           					WHERE	CD_NM =  #{educationVO.cost} 
				           				)
				        </if>
 					    <if test="educationVO.educationType != null">
				           AND EDU_TP = (
					           				SELECT	CD_ID
					           				FROM	EDU_TIME
					           				WHERE	CD_NM = #{educationVO.educationType} 
					           			)
				        </if>      
			 		   <if test="educationVO.educationTitle != null">
				           AND LOWER(EDU_TTL) LIKE '%'||#{educationVO.educationTitle} ||'%'
			           </if>
                        ORDER   BY EDU_ID DESC
                     ) EDU_INFO
               WHERE   ROWNUM <![CDATA[<=]]> #{searchVO.endIndex}
            ) EDU
            , EDU_CST
			, EDU_TIME
      WHERE   RNUM >= #{searchVO.startIndex}
	  AND     EDU.COST = EDU_CST.CD_ID
	  AND	  EDU.EDU_TP = EDU_TIME.CD_ID
    </select>

	 <insert id="insertNewComment" parameterType="QNAVO">
			INSERT INTO SEMS.QNA (
								   REPLY_ID 
								   , EDU_ID 
								   , PARENT_REPLY_ID 
								   , ORDER_NO 
								   , DESCRIPTION 
								   , MBR_ID 
								   , CREATED_DATE
								   ) 
						VALUES ( 
								 #{replyId},
								 #{eduId},
								 '0',
								 '4',
								 #{description},
								 #{mbrId},
								 SYSDATE
								 )			
 	</insert>
 	
	<delete id="doCancelEducation" parameterType="string">
		DELETE	
		FROM	EDU_HTR
		WHERE	EDU_ID = #{educationId}
		AND		MBR_ID = #{id} 
	</delete>
    
    <select id="getMemberRegInfo" parameterType="string"  resultType="EducationVO">
    	SELECT	EDU.EDU_ID educationId
				, EDU.EDU_CTGR educationCategory
				, EDU.EDU_TTL educationTitle
				, EDU.MBR_ID memberId
				, EDU.MAX_MBR maxMember
				, EDU.EDU_LOC educationLocation
				, EDU.EDU_CLCM educationCurriculum
				, EDU.EDU_INTR educationIntroduce
				, EDU.SRT_DATE startDate
				, EDU.END_DATE endDate
				, EDU.START_TM startTime
				, EDU.END_TM endTime
				, EDU.EDU_TP educationType
		 		, EDU_TIME.CD_NM typeName
				, EDU_CST.CD_NM costName 
		FROM	EDU_INFO EDU
				, EDU_CST
				, EDU_TIME
		WHERE	EDU_ID IN (
	                        SELECT  EDU_ID
	                        FROM    EDU_HTR
	                        WHERE   MBR_ID = #{id}
	                        )
		AND		EDU.COST = EDU_CST.CD_ID
		AND		EDU.EDU_TP = EDU_TIME.CD_ID
    </select>
    
    <insert id="doApplyEducation" parameterType="map">
    	INSERT INTO SEMS.EDU_HTR (
								   EDU_HTR_ID
								   , EDU_ID
								   , MBR_ID
								   , EDU_HTR_DT
								   , STAT
								   , IP
								   , CMNT
								   , FDBK
								   ) 
						VALUES ( 
								EDU_HTR_ID_SEQ.NEXTVAL
								, #{educationId}
								, #{id}
								, SYSDATE
								, 'EDU_JN_A'
								, '127.0.0.1'
								, ''
								, ''
							 )
   	</insert>
   	
   	<insert id="doReserveEducation" parameterType="map">
    	INSERT INTO SEMS.EDU_HTR (
								   EDU_HTR_ID
								   , EDU_ID
								   , MBR_ID
								   , EDU_HTR_DT
								   , STAT
								   , IP
								   , CMNT
								   , FDBK
								   ) 
						VALUES ( 
								EDU_HTR_ID_SEQ.NEXTVAL
								, #{educationId}
								, #{id}
								, SYSDATE
								, 'EDU_RE_A'
								, '127.0.0.1'
								, ''
								, ''
							 )
   	</insert>
    
    <select id="isApplyMemberByEducationId" parameterType="map" resultType="string">
    	SELECT  STAT
    	FROM	EDU_HTR
    	WHERE	EDU_ID = #{educationId}
    	AND		MBR_ID = #{id}
    </select>
    
    <select id="getEduReplyCount" parameterType = "string" resultType="_int">
   		SELECT 	COUNT(*)	
		FROM	QNA
		WHERE 	EDU_ID = #{educationId}
    </select>
    
    <select id="getCostName" resultType="string">
    	SELECT  CD_NM
    	FROM	EDU_CST
    </select>
    
    <select id="getTypeName" resultType="string">
    	SELECT  CD_NM
    	FROM	EDU_TIME
    </select>
	
	<select id="doTransCostId" parameterType="string" resultType="string">
		SELECT  CD_ID
		FROM	EDU_CST
		WHERE   CD_NM = #{cost}
	</select>

	<select id="doTransTypeId" parameterType="string" resultType="string">
		SELECT  CD_ID
		FROM	EDU_TIME
		WHERE   CD_NM = #{educationType}
	</select>
	
	<select id="getTotalQNACount" parameterType="QNASearchVO" resultType="_int">
		SELECT	COUNT(REPLY_ID)
		FROM	(
					SELECT	QNA.*
					FROM	(
								SELECT	*
								FROM	QNA
								WHERE	MBR_ID = #{id}
								AND		PARENT_REPLY_ID = '0'
								<if test="searchKeyword != null and searchType != null">
								AND		(
										<if test="searchType == 'replyId'">
											REPLY_ID LIKE '%' || #{searchKeyword} || '%'
										</if>
										<if test="searchType == 'eduId'">
											EDU_ID LIKE '%' || #{searchKeyword} || '%'
										</if>
										<if test="searchType == 'description'">
											DESCRIPTION LIKE '%' || #{searchKeyword} || '%'
										</if>
										)
								</if>
								<if test="startDate != null and startDate != ''">
								AND		CREATED_DATE >= #{startDate}
								</if>
								<if test="endDate != null and endDate != ''">
								AND		CREATED_DATE <![CDATA[<]]> TO_DATE(#{endDate}, 'YYYY-MM-DD') + 1
								</if>
								ORDER	BY REPLY_ID DESC
							) QNA
				) Q
		WHERE	PARENT_REPLY_ID = '0'
	</select>
	
	<select id="getAllQNAList" parameterType="QNASearchVO" resultType="QNAVO">
		SELECT	Q.REPLY_ID replyId
				, Q.EDU_ID eduId
				, Q.PARENT_REPLY_ID parentReplyId
				, Q.ORDER_NO orderNo
				, Q.DESCRIPTION description
				, Q.MBR_ID mbrId
				, Q.LIKE_CNT likeCnt
				, Q.DISLIKE_CNT dislikeCnt
				, Q.CREATED_DATE createdDate
				, NVL ( (
						SELECT	DISTINCT 'Y'
						FROM	QNA
						WHERE	PARENT_REPLY_ID IN Q.REPLY_ID
				) , 'N' ) isAnswered
		FROM	(
					SELECT	ROWNUM AS RNUM
							, QNA.*
					FROM	(
								SELECT	*
								FROM	QNA
								WHERE	MBR_ID = #{id}
								AND		PARENT_REPLY_ID = '0'
								<if test="searchKeyword != null and searchType != null">
								AND		(
										<if test="searchType == 'replyId'">
											REPLY_ID LIKE '%' || #{searchKeyword} || '%'
										</if>
										<if test="searchType == 'eduId'">
											EDU_ID LIKE '%' || #{searchKeyword} || '%'
										</if>
										<if test="searchType == 'description'">
											DESCRIPTION LIKE '%' || #{searchKeyword} || '%'
										</if>
										)
								</if>
								<if test="startDate != null and startDate != ''">
								AND		CREATED_DATE >= #{startDate}
								</if>
								<if test="endDate != null and endDate != ''">
								AND		CREATED_DATE <![CDATA[<]]> TO_DATE(#{endDate}, 'YYYY-MM-DD') + 1
								</if>
								ORDER	BY REPLY_ID DESC
							) QNA
					WHERE	ROWNUM <![CDATA[<=]]> #{endIndex}
				) Q
		WHERE	RNUM <![CDATA[>=]]> #{startIndex}
	</select>

	<select id="getSelectedQNA" parameterType="string" resultType="QNAVO">
		SELECT		REPLY_ID replyId
					, EDU_ID eduId
					, PARENT_REPLY_ID parentReplyId
					, ORDER_NO orderNo
					, DESCRIPTION description
					, MBR_ID mbrId
					, LIKE_CNT likeCnt
					, DISLIKE_CNT dislikeCnt
					, CREATED_DATE createdDate
		FROM		QNA
		WHERE		REPLY_ID = #{replyId}
	</select>
	
	<select id="getSelectedQNAAnswer" parameterType="string" resultType="QNAVO">
		SELECT		REPLY_ID replyId
					, EDU_ID eduId
					, PARENT_REPLY_ID parentReplyId
					, ORDER_NO orderNo
					, DESCRIPTION description
					, MBR_ID mbrId
					, LIKE_CNT likeCnt
					, DISLIKE_CNT dislikeCnt
					, CREATED_DATE createdDate
		FROM		QNA
		WHERE		PARENT_REPLY_ID = #{replyId}
	</select>
	
	<select id="exportQNAListAsExcel" parameterType="string" resultType="QNAVO">
		SELECT		Q.REPLY_ID replyId
					, Q.EDU_ID eduId
					, Q.PARENT_REPLY_ID parentReplyId
					, Q.ORDER_NO orderNo
					, Q.DESCRIPTION description
					, Q.MBR_ID mbrId
					, Q.LIKE_CNT likeCnt
					, Q.DISLIKE_CNT dislikeCnt
					, Q.CREATED_DATE createdDate
					, NVL ( (
						SELECT	DISTINCT 'Y'
						FROM	QNA
						WHERE	PARENT_REPLY_ID = Q.REPLY_ID
					 ) , 'N' ) isAnswered
		FROM	QNA Q
		WHERE	Q.MBR_ID = #{memberId}
		AND		Q.PARENT_REPLY_ID = '0'
		ORDER	BY Q.REPLY_ID ASC
	</select>
	
	<select id="getApplyHistory" parameterType="map" resultType="EduClassVO">
		SELECT	EDU_CLASS_ID educationClassId
				, EDU_ID educationId
				, MBR_ID memberId
				, STAT status
		FROM	EDU_CLASS
		WHERE	MBR_ID = #{ memberId }
		AND		EDU_ID = #{ educationId }
		AND		(STAT = 'EDU_JN_A'
		OR		STAT = 'EDU_JN_C')
	</select>

	<insert id="doReReplyInsert" parameterType="QNAVO">
		INSERT INTO QNA (
						   REPLY_ID 
						   , EDU_ID 
						   , PARENT_REPLY_ID 
						   , ORDER_NO 
						   , DESCRIPTION 
						   , MBR_ID 
						   , CREATED_DATE
						   ) 
					VALUES ( 
							 #{replyId},
							 #{eduId},
							 #{parentReplyId},
							 '4',
							 #{description},
							 #{mbrId},
							 SYSDATE
							 )			
	</insert>

	<select id="getEmail" parameterType="string" resultType="string">
		SELECT	EMAIL
		FROM	MBR
		WHERE	ID = #{id}
	</select>
	
	<select id="getNextReReplyEval" resultType="_int">
		SELECT 	REPEPLY_EVAL_ID_SEQ.NEXTVAL
		FROM	DUAL
	</select>
	
	<update id="plusReReplyLike" parameterType="string">
		UPDATE	QNA
		SET		LIKE_CNT = LIKE_CNT+1
		WHERE	REPLY_ID = #{replyId}
	</update>
	
	<insert id="insertReReplyEval" parameterType="ReRplyEvalVO">
		INSERT INTO RERPLY_EVAL (
								   REPLY_ID
								   , MBR_ID
								   , LIKE_CNT
								   , DISLIKE_CNT
								   , CREATED_DATE
								   , REPLY_EVAL_ID
							   	) 
		VALUES					( 
									#{replyId}
									, #{mbrId}
									, 'Y'
							 		, 'N'
							 		, SYSDATE
							 		, #{replyEvalId}
								)	
								
	</insert>
	
	<select id="checkReReplyEval" parameterType="ReRplyEvalVO" resultType="_int">
		SELECT	COUNT(REPLY_EVAL_ID)
		FROM	RERPLY_EVAL
		WHERE	MBR_ID = #{mbrId}
		AND		REPLY_ID = #{replyId}
		AND		(LIKE_CNT = 'Y'
		OR		DISLIKE_CNT = 'Y')
	</select>
	
	<select id="getStartYear" resultType="string">
		SELECT	SUBSTR(SDATE, 0, 4) SDATE
		FROM	(
                    SELECT  SRT_DATE SDATE
                    FROM    EDU_INFO
                    ORDER   BY SRT_DATE ASC
                )
		WHERE   ROWNUM = 1
	</select>
	
	<select id="getEndYear" resultType="string">
		SELECT	SUBSTR(EDATE, 0, 4) EDATE
		FROM	(
                    SELECT  END_DATE EDATE
                    FROM    EDU_INFO
                    ORDER   BY END_DATE DESC
                )
		WHERE   ROWNUM = 1
	
	</select>
	
	<insert id="insertReReplyEvalByDislike" parameterType="ReRplyEvalVO">
		INSERT INTO RERPLY_EVAL (
									   REPLY_ID
									   , MBR_ID
									   , LIKE_CNT
									   , DISLIKE_CNT
									   , CREATED_DATE
									   , REPLY_EVAL_ID
								   	) 
		VALUES					( 
										#{replyId}
										, #{mbrId}
										, 'N'
								 		, 'Y'
								 		, SYSDATE
								 		, #{replyEvalId}
									)
	</insert>
	
	<update id="plusReReplyDislike" parameterType="string">
		UPDATE	QNA
		SET		DISLIKE_CNT = DISLIKE_CNT+1
		WHERE	REPLY_ID = #{replyId}
	</update>
	
	<update id="doRequestRetraction" parameterType="map">
		UPDATE	EDU_STAT
		SET		STAT = 'EDU_CL_A'
		WHERE	EDU_ID = #{ educationId }
		AND		MBR_ID = #{ memberId }
	</update>
	
	<insert id="addRequestRetractionHistory">
		INSERT INTO EDU_HTR (
							   EDU_HTR_ID
							   , EDU_ID
							   , MBR_ID
							   , EDU_HTR_DT
							   , STAT
							   , IP
							   , CMNT
							   , RATIO
							) 
		VALUES 				( 
								EDU_HTR_ID_SEQ.NEXTVAL
								, #{ educationId }
								, #{ memberId }
								, SYSDATE
								, 'EDU_CL_A'
								, #{ ip }
								, #{ retractionMsg }
								, 0
							)
	</insert>
	
	<delete id="doReReplyDelete" parameterType="QNAVO">
		DELETE
		FROM	QNA
		WHERE	REPLY_ID = #{replyId}
	</delete>
	
	<delete id="deleteReReplyEvalByDislike">
		DELETE
		FROM	RERPLY_EVAL
		WHERE	REPLY_EVAL_ID = #{replyEvalId}
	</delete>
	
	<delete id="deleteReReplyEval">
		DELETE
		FROM	RERPLY_EVAL
		WHERE	REPLY_EVAL_ID = #{replyEvalId}
	</delete>
		
	<select id="getTotalMemberNumber" parameterType="string" resultType="_int">
		SELECT	COUNT(EDU_HTR_ID)
		FROM	EDU_HTR
		WHERE	EDU_ID = #{educationId}
		AND		( STAT = 'EDU_JN_A'
		OR		STAT = 'EDU_JN_C' )
	</select>
	
	<update id="updateStateToApply" parameterType="string">
		UPDATE	EDU_HTR
		SET		STAT = 'EDU_JN_A'
		WHERE	EDU_HTR_ID = (
								SELECT	EDU_HTR_ID
								FROM	(
											SELECT	*
											FROM	EDU_HTR
											WHERE	STAT = 'EDU_RE_A'
											AND		EDU_ID = #{educationId}
											ORDER BY	EDU_HTR_DT ASC
										)
								WHERE	ROWNUM = 1
					    	)		
	</update>

	<!-- 평화
	<select id="getMyEducationList" parameterType="string" resultType="EducationVO">
		
	</select>
	  -->


	<select id="getTotalEduReportCount" parameterType="EduReportSearchVO" resultType="_int" >
		SELECT	COUNT(ATC_ID)
		FROM	EDU_RPT_BBS
		<if test="searchType == 1 and searchType != null">
		WHERE	MRB_ID = #{searchKeyword}
		AND		EDU_ID = #{educationId}
		</if>
		<if test="searchType == 2 and searchType != null">
		WHERE	TITLE = #{searchKeyword}
		AND		EDU_ID = #{educationId}
		</if>
		<if test="searchType == null">
		WHERE	EDU_ID = #{educationId}
		</if>
		ORDER	BY	ATC_ID DESC
	</select>
	
	<select id="getAllEduReport" parameterType="EduReportSearchVO" resultType="EduReportVO">
		 SELECT ATC_ID eduReportId
		 		, EDU_ID educationId
		 		, IS_DELETE isDelete
		 		, MRB_ID memberId
		 		, TITLE title
		 		, CONTENTS contents
		 		, CREATE_DATE createDate
		 		, MODIFY_DATE modifyDate
		 		, HITS hits
		FROM	(
					SELECT	ROWNUM AS RNUM
							, EDU_RPT.*
					FROM	(
								SELECT	*
								FROM	EDU_RPT_BBS
								WHERE	EDU_ID = #{educationId}
								<if test="searchType == 1 and searchType != null">
								AND		MRB_ID LIKE '%'||#{searchKeyword}||'%'
								</if>
								<if test="searchType == 2 and searchType != null">
								AND		TITLE LIKE '%'||#{searchKeyword}||'%'
								</if>
								<if test="searchType == 3 and searchType != null">
								AND		MRB_ID = #{searchKeyword}
								</if>
								<if test="searchType == 4 and searchType != null">
								AND		TITLE LIKE '%'||#{searchKeyword}||'%'
								</if>
								ORDER	BY ATC_ID
							)EDU_RPT
					WHERE	ROWNUM <![CDATA[<=]]> #{endIndex}
				)
		WHERE	RNUM <![CDATA[>=]]> #{startIndex}
	</select>
	
	<select id="getAllMemberOfEducation" parameterType="string" resultType="MemberVO">
		SELECT	ID id
				, PWD password
				, NM name
				, EMAIL email
				, HIGHEST_EDU_LV highestEducationLevel
				, UNIV_NM universityName
				, MJR_NM majorName
				, GRDT_TP graduationType
				, BRTH_DT birthDate
				, PHONE_NMB phoneNumber
				, MBR_TP memberType
				, SALT salt
				, LGI_F_CT loginFailCount
				, IS_ACC_LCK isAccountLock
				, TO_CHAR(LATEST_LGI_DT, 'YYYY-MM-DD') latestLoginDate
				, RSN_DT resignDate
				, RSN isResign
				, MDF_F_CT modifyFailCount
				, IS_MDF_LCK isModifyLock
				, UUID uuid
		FROM	MBR M
				, EDU_HTR EH
		WHERE	M.ID = EH.MBR_ID
		AND		EH.EDU_ID = #{ educationId }
	</select>
	
	<select id="getAllEducationQNAList" resultType="EducationQNABBSVO">
		SELECT	ATC_ID atcId
				, EDU_ID eduId
				, MBR_ID mbrId
				, IS_DELETE isDelete
				, TITLE title
				, CONTENTS contents
				, CREATE_DATE createDate
				, MODIFY_DATE modifyDate
				, HITS hits
		FROM	EDU_QA_BBS
		ORDER 	BY atcId DESC 
	</select>
	
	<insert id="addQNABBS" parameterType="EducationQNABBSVO">
		INSERT INTO EDU_QA_BBS	(
								   ATC_ID 
								   , TITLE
								   , CONTENTS
								   , CREATE_DATE
								   , MBR_ID
								   , EDU_ID
								) 
						VALUES ( 
								 ATC_ID_SEQ.NEXTVAL 
								 , #{title}
								 , #{contents}
								 , SYSDATE
								 , #{mbrId}
								 , #{eduId}
								 )		
	</insert>
	
	<select id="getAllEducationReportList" resultType="EducationReportVO" >
		SELECT	ATC_ID articleId
		        , EDU_ID educationId
		        , MBR_ID memberId
		        , TITLE title
		        , CONTENTS contents
		        , START_DATE startDate
		        , END_DATE endDate
		FROM	(
		            SELECT	ROWNUM AS RNUM
		                    , EDU_RPT_BBS.*
		            FROM	(
		                        SELECT	*
		                        FROM	EDU_RPT_BBS
		                        WHERE	EDU_ID = #{educationId}
		                        <if test="searchKeyword != null and searchType != null">		
									<if test="searchType == 'title'">
									AND		TITLE LIKE '%' || #{searchKeyword} || '%'
									</if>
									<if test="searchType == 'contents'">
									AND		CONTENTS LIKE '%' || #{searchKeyword} || '%'
									</if>
									<if test="searchType == 'registerId'">
									AND		MBR_ID LIKE '%' || #{searchKeyword} || '%'
									</if>
								</if>
								<if test="startDate != null and startDate != ''">
								AND		START_DATE >= #{startDate}
								</if>
								<if test="endDate != null and endDate != ''">
								AND		END_DATE <![CDATA[<]]> TO_DATE(#{endDate}, 'YYYY-MM-DD') + 1
								</if>
		                        ORDER	BY ATC_ID DESC
		                    ) EDU_RPT_BBS
		            WHERE	ROWNUM <![CDATA[<=]]> #{endIndex}
		        ) ERB
		WHERE	RNUM <![CDATA[>=]]> #{startIndex}
	</select>
	
	<select id="getTotalEducationReportCount" parameterType="EducationReportSearchVO" resultType="_int">
		SELECT  COUNT(ATC_ID)
		FROM    EDU_RPT_BBS
		WHERE	1=1
		<if test="searchKeyword != null and searchType != null">
			<if test="searchType == 'title'">
			AND		TITLE LIKE '%' || #{searchKeyword} || '%'
			</if>
			<if test="searchType == 'contents'">
			AND		CONTENTS LIKE '%' || #{searchKeyword} || '%'
			</if>
			<if test="searchType == 'registerId'">
			AND		MBR_ID LIKE '%' || #{searchKeyword} || '%'
			</if>
		</if>
		<if test="startDate != null and startDate != ''">
			AND		CREATE_DATE >= #{startDate}
		</if>
		<if test="endDate != null and endDate != ''">
			AND		MODIFY_DATE <![CDATA[<]]> TO_DATE(#{endDate}, 'YYYY-MM-DD') + 1
		</if>
	</select>
	
	<select id="getOneQNABBSByAtcId" parameterType="string" resultType="EducationQNABBSVO">
		SELECT	ATC_ID atcId
				, EDU_ID eduId
				, MBR_ID mbrId
				, IS_DELETE isDelete
				, TITLE title
				, CONTENTS contents
				, CREATE_DATE createDate
				, MODIFY_DATE modifyDate
				, HITS hits
		FROM	EDU_QA_BBS
		WHERE	ATC_ID = #{atcId}
	</select>
	
	<select id="getNextReportSeq" resultType="_int">
		SELECT 	ATC_ID_SEQ.NEXTVAL
		FROM	DUAL
	</select>	
	
	<insert id="doReportWriteAction" parameterType="EducationReportVO">
		INSERT	INTO EDU_RPT_BBS (
									ATC_ID
									, EDU_ID
									, MBR_ID
									, TITLE
									, CONTENTS
									, CREATE_DATE
									, MODIFY_DATE
								 )
		VALUES				     (
									#{articleId}
									, #{educationId}
									, #{memberId}
									, #{title}
									, #{contents}
									, TO_DATE(#{startDate}, 'YYYY-MM-DD HH24:MI')
									, TO_DATE(#{endDate}, 'YYYY-MM-DD HH24:MI')
								 )
		
	</insert>
	
	<update id="addHitsByAtcId" parameterType="string">
		UPDATE	EDU_QA_BBS
		SET		HITS = HITS+1
		WHERE	ATC_ID = #{atcId}
	</update>
	
	<insert id="addQNAReply" parameterType="EducationQNAReplyVO">
		INSERT INTO BBS_RPL (
								   REPLY_ID 
								   , ATC_ID 
								   , PARENT_REPLY_ID 
								   , ORDER_NO 
								   , DESCRIPTION 
								   , MBR_ID 
								   , CREATED_DATE
								   ) 
						VALUES ( 
								 #{replyId},
								 #{atcId},
								 '0',
								 '4',
								 #{description},
								 #{mbrId},
								 SYSDATE
								 )
	</insert>
	
	<select id="getOneEducationReport" parameterType="EducationReportVO" resultType="EducationReportVO">
		SELECT	EDU_ID educationId
				, MBR_ID memberId
				, TITLE title
				, CONTENTS contents
				, START_DATE startDate
				, END_DATE endDate
		FROM	EDU_RPT_BBS
		WHERE	ATC_ID = #{articleId}
	</select>
</mapper>
